---
title: "The FEMSdevPkg"
output: 
  rmarkdown::pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true

vignette: >
  %\VignetteIndexEntry{FEMSdevPkg}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
author: "Henriette Elise Breymann and others"
date: "`r Sys.Date()`"
---

\newpage


# Introduction

## The digital financial world

Today's financial system is digital and banks can rightly be considered as 
applied IT companys. Our money, our investments and debts are just zillions of 
numbers in
huge data bases. From this persective the banking business can formally be
considered of a transformation of these numbers according to specific rules.
And these transformations must be highly automated; otherwise banks could not function. 

Unfortunately, the treatment of these numbers is not totally automated across the boards. 
Sure, the parts that are vital for banks to subsist do work automatically. 
This mainly concerns financial transactions.
But there are other parts that, even though equally important for controlling 
and steering the institutions, are
not as vital for the daily business and thus less integrated. 
Which generates
large costs for financial institutions and limits the impact of what could be 
achieved with optimal automation.
It also limits the possible impact of regulation.

```{=latex}
\begin{figure}[h] 
  \begin{center}
  \includegraphics[width = 15cm]{./figures/Rabobank_IT.jpg}
  \end{center}
  \caption{Model of the IT landscape of the Rabobank. (from linked-in)}
  \label{fig:Rabo-IT}
\end{figure}
```

The technical reason is the fragmented IT landscape which itself is a result of 
the way this
landscape grew over the years, piece by piece. Each piece --- or subsystem ---
works well for itself but they are not optimally working together. The problem is
the interfaces and, closely related to this, the data standards. And these two very
technical aspects are closely related to the task that they should support, namely
different aspects of banking. 
Which means that optimal interfaces and data standards that are up to the
task cannot be constructed without a thorough understanding of banking and finance. 
And here is
the rub: IT and banking expertise are rarely found together in a single person.
Bankers care little about the underlying IT, and IT specialists usually are not very 
literate in banking. Moreover, different lines of business largely work independent
from one another. Which leads to silo-type structures: integration is well advanced
within a silo but poor across silos. This means that integration across silos
still requires a lot of manual work. Tasks that require this type of integration 
can only be carried out in a suboptimal way. As a consequence, regulatory reporting, 
which 
requires presicely this type of integration, is slow and costly. And the cost-income ratio
of banks is around 60\% or higher. 


To help overcoming these shortcomings, 
a special infrastructural layer has been developed. However, in order to 
motivate the need of this layer and its rationale, 
let's first turn to the fundamental building blocks of finance.



## Financial contracts --- the molecules of the financial system

The financial system deals with money. Or, more precisely, with the exchange 
of money. The most elementary element (the atom) is the exchange of a single
cash flow between two parties. It appropriately describes, e.g., 
the actions of putting money on or withdrawing
it from a bank account. However, for most finance activities this is
a level too low because usually cash flows do not arise in isolation but are 
bundled together because they form a whole and serve a purpose. 
These bundles are defined by contractual obligations, 
so-called financial contracts.
A bond, a loan, a mortgage are prime examples. If you buy a fixed-rate bond, e.g.,
you initially pay the sum to invest. Then you get regularly interest payments and
at the end of its term (maturity) you get your invested money back together with
the last interest payment. All these payments are defined by the terms of the 
contract called \emph{bond}. 
In general, a financial contract defines a set of cash flow exchanges
between two or more parties. 
The time and amount of cash flows may depend
on well-defined external factors. However, the value of these external factors is not 
known when the contract is concluded and brings an essential element of change
into the game. Just think of the value of a stock.

To stay in the above-mentioned analogy, 
financial contracts are the molecules of the financial system. While in nature 
there are only
about 100 (stable) atoms, there are millions of different molecules, from simple ones
as $\text{H}_2\text{O}$ to very complicated, ones such as e.g. alkane chains, 
that may consist of thousands of atoms. All these molecules serve different purposes.
Similarly, there are myriads of (often bespoke) financial contracts, 
which also serve different, partly very special purposes. 
Examples are structured products, exotic derivatives bonds and over-the-counter 
contracts.

```{=latex}
\begin{figure}[h] 
  \begin{center}
  \includegraphics[width = 15cm]{./figures/bowtie.pdf}
  \end{center}
  \caption{Bowtie structure of the financial system with the ACTUS contract types
  at its center. Financial contracts have a central role in the structure
of the financial system. 
It contains very diverse inputs (left) and outputs (right) but a highly standardized
and efficient core in the center. }
  \label{fig:Bowtie}
\end{figure}
```

From the central role of financial contracts it's immediately clear that they
should be the prime focus of standardization. And they should make it possible
to close the gap in the automation of financial analysis.
There have indeed been quite a few
attempts,
each of them focusing on different subsets of financial contracts and with different
purposes in mind. FpML, e.g., 
only focuses on derivatives with the goal of supporting automated transaction. 
Ontologies such as Fibo classify financial contracts my means of deep hierachies 
with the goal of unequivocal identification of any financial contract. All these
standardization efforts, however, fall short in one way or another. In particualr, 
they are not encompassing and don't provide the information needed for financial
analysis. Thus, they are not suitable for supporting automated financial analysis.
To achive this goal, the requirements of financial analytics most be cast. into
the definition of the standard at its very inception.

However, this requires compatible representations of all different types of 
contracts. This can best be done at the level of the cash flow stream encoded
by the contract. Indeed, the whole financial analytics can be computed from
these cash flow streams \cite{BBS22}. There are three large groups of analytics: 
liquidity analysis, valuation, and the 
computation of income. Each of them can be derived from the cash flow stream 
encoded by a financial contract provided that some additional information is 
attached to the cash flows \cite{BBS22}. 
Moreover, only linear mathematical
operations are required. 
Aggregation across contracts can be done in a similar way by linear 
operations \cite{BBS22}. These requirements of financial analytics must be cast 
into the standard at its very inception.

What is needed is thus a standardized digital representation of the cash flow
streams that are encoded by the whole universe of financial contracts. Such a 
standard would allow a very efficient automation of financial analysis because
it makes apparent the boy-tie structure of the financial system as depicted
in figure \ref{fig:Bowtie} with a highly standardized, very robust and 
computationally efficient core at the center and great variety in the wings.
Such a structure is often found in complex systems showing up in nature and 
society. An example outside the world of finance is the metabolism. 

This seems a formidable task. However, 
from the point of view of pure number processing, the huge variety of 
different contracts shrinks enormously. Because the aim of the standard 
is not to unequivocally describe what a contract is (= ontology) but how a 
works. I.e., which cash flows it generates. To put it philosophically, it's not
a question of being, of unequivocal identification, but of a contract's mode
of action. 

<!-- \clearpage -->

## The Algorithmic Contract Type Unified Standard (ACTUS)

The standard that has been constructed with the automation of forward-looking
financial analytics in mind is the so-called ACTUS Algorithmic Contract Type 
Unified Standard. 
It consists of two part, namely

- the ACTUS Data Dictionary (ADD) and

- the ACTUS Cashflow Generation Algorithm (ACGA).

The first standardizes the data involved in a financial contract and the second
standardizes the digital representation of the cash flow stream encoded by a
financial contract.  

Notice that ACTUS cannot be used standalone. It's an enabler. 
Such as the standardization of nuts 
of bolts in the 19th century was an enabler.
A box of standardized 
nuts and bolts without using them for the construction of some device is also 
pointless. Still, this standardization gave a boost to industrial development. 

The situation in the financial system is somewhat more subtle. The part
that is mandatory for running the daily business is indeed suitably standardized.
These are the transaction systems. However, as has been pointed out above, 
there is another layer that concerns
the analytics for both, purposes internal to the institution (upper management) 
and external purposes (e.g. regulation). These parts show serious shortcomings.
Unfortunately, usually these shortcomings are papered over and only pop up in
situations of crises. Up to now no
serious effort have been made to fundamentally remedy the situation even though 
this would save the banks considerable costs and would made regulation more 
transparent and effective, and, as a consequence, the financial system more stable.

\newpage

## The logic of ACTUS

```{=latex}
\begin{figure}[t] 
  \begin{center}
  \includegraphics[width = 15cm]{./figures/ACTUS_logic.pdf}
  \end{center}
  \caption{The data-processing logic of an ACTUS contract.}
  \label{fig:ACTUS-logic}
\end{figure}
```

Figure \ref{fig:ACTUS-logic} displays the data-processing logic of a ACTUS 
contract, which is represented as the green box in the center. You can think
of this box of containing the contract data as nominal, interest rate, start
date, maturity date, etc. These data together with the rules of how to convert
them into future cash flows define the contents of the contract. This information,
however, is not sufficient to derive the future cash flow stream. The reason is 
that some contractual terms make reference to outside quantities. For a variable bond,
e.g., the market interest rate is needed for each data, when the interest to be
paid is adapted to the then prevailing market date. An option on a stock requires
the knowledge of the stock price. Different contract require different information
elements from a contract's economic-financial environment. These is data about 
future market developments, 
which is not available at the time of the evaluation of the future cash flows. 
They introduce an important element of risk in the evaluation of a contrast's
future cash flows. Therefore they are henceforce called risk factors.

From the contract data and the risk factor data, a contract's future cash flow
stream can be evaluated by means of the ACTUS Cash-flow Generating Algorithm (ACGA).
This is indicated by the elliptical box under the contract box. The result (light
blue line in the middle) is
the contract's cash flows conditional to the risk factor scenario used in the 
evaluation. These are the raw results. From these raw results, all further analysis
can be derived, cf. dark blue box at the bottom.

## Portfolios of contracts and different risk factor scenarios

```{=latex}
\begin{figure}[h] 
  \begin{center}
  \includegraphics[width = 15cm]{./figures/ACTUS_logic2.png}
  \end{center}
  \caption{Data processing for a portfolio of $n$ contracts and $k$ risk factor
  environments.}
  \label{fig:ACTUS-logic2}
\end{figure}
```

Figure \ref{fig:ACTUS-logic2} illustrates what happens in the case of a portfolio
of $n$ contracts and the presence of $k$ risk factor scenarios.
The contract input data in the ACTUS standard are represented by the blue 
rectangles at the top of the input (left) part of the figure. The execution steps 
consist of (i) creating stochastic risk factor models and scenarios for stress 
testing and Monte Carlo simulations (represented by the red rectangles at the 
bottom of the input part); (ii) simulating the contracts’ future cash flows 
under suitable scenarios for the risk factors (i.e., the arrow that represents 
the ACTUS algorithms that transforms input data into (raw) cash flow results; 
(iii) extracting from these cash flows the analytical quantities needed for a 
suitable level of aggregation (i.e., arrow “Analytics”). 
<!-- and (iv) optional  -->
<!-- storage of any of these intermediate results in a scalable persistent datastore  -->
<!-- to allow reuse, trend analysis and comparisons of specific portfolio and  -->
<!-- scenario subgroups. This analysis enables regulators authorized to access the  -->
<!-- contract level positions of an institution to assess its vulnerability towards  -->
<!-- any relevant stress event by suitable aggregation of the granular data.  -->
<!-- This can be done for individual institutions or for the financial system overall.  -->
Notice that in step (iii) with the exception of the evaluation of risk measures,
all operations that require extensive aggregation are linear operations (additions
and multiplications) and can very well be executed with databases. 

In figure \ref{fig:ACTUS-logic2}, the evaluation of risk factor models, 
the cash-flow generation, and the performance of the analytics are separate steps. 
This serves two purposes: (i) Separating the huge number of contract information 
that is known (since it’s written in the contracts) from the stochastic, 
and thus a priori unknown risk factor information, in view of transparent and 
parsimonious modeling; 
(ii) supporting the efficient computation of a large variety of analytical 
quantities by only changing the aggregation part. 


<!-- ```{=latex} -->
<!-- \begin{figure}[h]  -->
<!--   \begin{center} -->
<!--   \includegraphics[width = 15cm]{./figures/Cashflow-Aggregation.pdf} -->
<!--   \end{center} -->
<!--   \caption{Aggregation of many ACTUS contracts. Notice that aggregation of  -->
<!--   cash flow stream only requires linear operations (lower part in green).} -->
<!--   \label{fig:ContractAggregation} -->
<!-- \end{figure} -->
<!-- ``` -->

```{=latex}
\begin{figure}[hb] 
  \begin{center}
  \includegraphics[width = 15cm]{./figures/System-interactions.png}
  \end{center}
  \caption{Sketch of the financial systems. The interactions are transmitted 
  by financial contracts.}
  \label{fig:SystemInteractions}
\end{figure}
```


## Toward the analysis of the financial system --- Sketch of an ACTUS ecosystem

At the end of this introduction we want to briefly point out the possibilities 
that open up if all banks have their contracts in the ACTUS format. If the 
contract information of all the contracts of all banks is available in a central 
database then it would be possible to simulate the future development of all
the banks conditional to the defined risk factor scenarios. I.e., the future 
development of the financial system. This is schematically sketched in figure \ref{fig:SystemInteractions}. This would be a powerful tool in the hand of 
regulators in situations of crises.

## Using ACTUS with FEMSdevPkg

ACTUS provides an infrastructural layer that 
makes financial analysis much more powerful. But it cannot be used in 
isolation. It's an enabler that needs an environment to make use of it. 
In order to give potential users the possibility to become acquainted with ACTUS
and the range of possibilities it provides, we've build the R-package 
\verb+FEMSdevPkg+. So it requires R as platform to run it. The ACTUS algorithms
are running on a separate server and the requests to the server and its answers
are provided through an interface.


The \verb+FEMSdevPkg+ gives users the possibility to try out
the modeling of single financial contracts, portfolios of contracts or whole 
institution on a demo level. The package uses the ACTUS contract standard and 
cash flow generating algorithms that are transparent, efficient and meant to be
usable for even large scale institutions. The aim of this package, however. is
to give users easy access to this technology at an introductory and  demonstration 
level. For production level systems the interest users should look for professional 
software solutions based on the ACTUS technology.\footnote{%
On example is the product suite of the Ariadne Business Analytics AG.}

<!-- \newpage -->

# The structure of the FEMSdevPkg

The package is composed of the following parts:


- Setup

- Contracts

- Risk factors

- Events

- Aggregation 
- Analytics

- The structure of an institution

- Demos with graphical user interface



# Setup
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(pandoc)
```

```{r setup, warning = FALSE}
library(FEMSdevPkg)
```
For the calculations, a server from [ACTUS Financial Research Foundation](www.actusfrf.com) hosted by ZHAW is used.
Here we define the serverURL required for all calculations.
```{r}
serverURL <- "https://dadfir3-app.zhaw.ch/"
```
Now we are all set to start creating contracts.

# Contracts

## Single Contracts

### Fixed Rate Contracts

Let's start with a simple PAM (Principal at Maturity) contract.
```{r}
pam1 <- bondvr("2013-12-31", maturity = "5 years", nominal = 1000,
               coupon = 0.02, paymentFreq = "1 year", role = "long",
               rateResetFreq = "Fixed rate")
```

We can have a look at the contract terms.
```{r}
unlist(pam1$contractTerms)
```

With the function `generateEventSeries()` we can generate all events of the contract.
The functions takes the following arguments:
- `contract`: The contract object
- `riskFactors``: A list of risk factors (can also be empty)
- `serverURL`: The URL of the server to be used for the calculations

```{r}
evs1 <- generateEventSeries(pam1, list(), serverURL)
unlist(list(contractID = evs1$contractID,
            contractType=evs1$contractType,
            statusDate= evs1$statusDate,
            riskFactors = evs1$riskFactors
))
evs1$events_df
```

The events can be plotted afterwards by calling the function `cashflowPlot()`.
```{r}
cashflowPlot(evs1)
```

### Variable Rate Contracts
Contracts can also have variable interest rates. Herefore, we need to initialize some interest rate risk factors first.

First of all, let's load the sample data from the package.
Suggestion: We could make it available inside the package and load it from there.
```{r}
mydatadir <- "./mydata"
installSampleData(mydatadir)
```

Now we can load the sample data.
```{r}
falling_fp <- paste0(mydatadir,"/UST5Y_fallingRates.csv")
rising_fp <-  paste0(mydatadir,"/UST5Y_risingRates.csv")
rfx_falling <- sampleReferenceIndex(falling_fp,"UST5Y_fallingRates", 
                                    "YC_EA_AAA",100)
rfx_rising <- sampleReferenceIndex(rising_fp,"UST5Y_risingRates",
                                   "YC_EA_AAA",100)
```

After that we can create a contract with variable rates and generate the events and outputs as before.
```{r}
pam2 <- bondvr("2020-12-31", maturity = "5 years", nominal = 50000,
               coupon = 0.02, paymentFreq = "3 months", role = "long",
               rateResetFreq = "1 years", rateResetSpread = 0.01 )
unlist(pam2$contractTerms)
evs2 <- generateEventSeries(pam2, list(rfx_falling), serverURL)
evs2$events_df
```
And also the cashflow plot.
**Need to figure out a way to adjust the size of the plot, not good yet!!**
```{r, width = 12, height = 8}
cashflowPlot(evs2)
```

## Portfolios of contracts

# Risk factors

# Events

# Aggregation 

# Analytics

# The Structure of an institution

# Demos with graphical user interface

\newpage

# References 

```{=latex}
\begingroup
\renewcommand{\section}[2]{}%
%\renewcommand{\chapter}[2]{}% for other classes
\begin{thebibliography}{99} 
  \bibitem{BBS22}
  W. Breymann, N. Bundi and K. Stockinger, 
  \emph{Contract-driven financial reporting: building automated analytics 
  pipelines with algorithmic contracts, Big Data and Distributed Ledger
  technology.} In V. Ravi and A. K. Cherukuri [eds.] 
  \emph{Handbook of Big Data Analytics. Vol. 2: Applications in ICT, security 
  and business analytics.} London, 2022.
\end{thebibliography}
\endgroup
```



